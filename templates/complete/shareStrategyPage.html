{% extends "complete/base.html" %}


{% block link %}
<link rel="stylesheet" type="text/css" href="/static/image-upload/webuploader.css" />
<link rel="stylesheet" type="text/css" href="/static/image-upload/style.css" />
{% endblock %}
{% block content %}

<div class="hero-wrap js-fullheight" style="background-image: url('/static/images/bg_4.jpg');">
  <div class="overlay"></div>
  <div class="container">
    <div class="row no-gutters slider-text js-fullheight align-items-center justify-content-center" data-scrollax-parent="true">
      <div class="col-md-9 ftco-animate text-center" data-scrollax=" properties: { translateY: '70%' }">
        <!-- <p class="breadcrumbs" data-scrollax="properties: { translateY: '30%', opacity: 1.6 }"><span class="mr-2"><a href="index.html">Home</a></span> <span class="mr-2"><a href="blog.html">Blog</a></span> <span>Blog Single</span></p> -->
         <div id="app-6">
           {% verbatim myblock %} <h1 class="mb-3 bread" data-scrollax="properties: { translateY: '30%', opacity: 1.6 }"> {{ message }}</h1> {% endverbatim myblock %}
            <input type="text"  id="title_input" class="form-control" v-model="message"></div>
      </div>
    </div>
  </div>
</div>

<section class="ftco-section ftco-degree-bg">
  <div class="container">
    <div class="row">
      
      <div class="col-md-8 ftco-animate">
        <div >
          <div class="form-group">
            <!-- <label for="title">题目</label> -->

          </div>
        
          <div>
            
          </div>
          <div>
            
            <label>攻略内容</label>
            <div  id="content" contenteditable="true">
                从这里开始.....
            </div>
          </div>
      </div>
<!-- 
        <h2 class="mb-3">10 Tips For The Traveler</h2>
        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Reiciendis, eius mollitia suscipit, quisquam doloremque distinctio perferendis et doloribus unde architecto optio laboriosam porro adipisci sapiente officiis nemo accusamus ad praesentium? Esse minima nisi et. Dolore perferendis, enim praesentium omnis, iste doloremque quia officia optio deserunt molestiae voluptates soluta architecto tempora.</p>
        <p>
          <img src="/static/images/image_7.jpg" alt="" class="img-fluid">
        </p>
        <p>Molestiae cupiditate inventore animi, maxime sapiente optio, illo est nemo veritatis repellat sunt doloribus nesciunt! Minima laborum magni reiciendis qui voluptate quisquam voluptatem soluta illo eum ullam incidunt rem assumenda eveniet eaque sequi deleniti tenetur dolore amet fugit perspiciatis ipsa, odit. Nesciunt dolor minima esse vero ut ea, repudiandae suscipit!</p>
        <h2 class="mb-3 mt-5">#2. Creative WordPress Themes</h2>
        <p>Temporibus ad error suscipit exercitationem hic molestiae totam obcaecati rerum, eius aut, in. Exercitationem atque quidem tempora maiores ex architecto voluptatum aut officia doloremque. Error dolore voluptas, omnis molestias odio dignissimos culpa ex earum nisi consequatur quos odit quasi repellat qui officiis reiciendis incidunt hic non? Debitis commodi aut, adipisci.</p>
        <p>
          <img src="/static/images/image_8.jpg" alt="" class="img-fluid">
        </p>
        <p>Quisquam esse aliquam fuga distinctio, quidem delectus veritatis reiciendis. Nihil explicabo quod, est eos ipsum. Unde aut non tenetur tempore, nisi culpa voluptate maiores officiis quis vel ab consectetur suscipit veritatis nulla quos quia aspernatur perferendis, libero sint. Error, velit, porro. Deserunt minus, quibusdam iste enim veniam, modi rem maiores.</p>
         -->

      </div> <!-- .col-md-8 -->
      <div class="col-md-4 sidebar ftco-animate">
          <div class="">
              <div id="wrapper">
                  <div id="container">
                      <!--头部，相册选择和格式选择-->
                      <div id="uploader">
                          <div class="queueList">
                              <div id="dndArea" class="placeholder">
                                  <div id="filePicker"></div>
                                  <!-- <p>或将照片拖到这里，单次最多可选300张</p> -->
                              </div>
                          </div>
                          <div class="statusBar" style="display:none;">
                              <div class="progress" style= "display: none;"> 
                                  <span class="text">0%</span>
                                  <span class="percentage"></span>
                              </div><div class="info"></div>
                              <div class="btns">
                                  <div id="filePicker2"></div><div class="uploadBtn">开始上传</div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
          
          <div class="sidebar-box" style="display: flex;"> 
              <button class="btn py-3 px-4 btn-primary" style="border-radius: 0px;margin: 0 auto;display: flex;">设置封面</button>
              <button class="btn py-3 px-4 btn-primary" style="border-radius: 0px;margin: 0 auto;display: flex;">上传图片</button>
          </div>
        <div class="sidebar-box">
          <form id="send_post_form" method="POST">
            {% csrf_token %}
            <div class="form-group">
              <input class="form-control" type="text" placeholder="城市">
            </div>
            <div class="form-group">
                <input class="form-control" type="text" placeholder="餐厅">
              </div>
              <div class="form-group">
                  <input class="form-control" type="text" placeholder="景点">
              </div>
              <div class="form-group">
                  <input  type="hidden" name="content" id="cnt2" />
                  <input  type="hidden" name="title" id="cnt3" />
              </div>
            </form>
        </div>
        <div class="sidebar-box">
            <div class="form-group">
                <button class="btn py-3 px-4 btn-primary" type="button" onclick="sendPost();" style="border-radius: 0px;display: flex;margin: 0 auto;">保存发布</button>
              </div>
          </div>

      
        
      </div>

    </div>
  </div>
</section> <!-- .section -->
{% endblock%}


{% block script %}

<script src="https://cdn.jsdelivr.net/npm/vue"></script>
<script>
var app6 = new Vue({
  el: '#app-6',
  data: {
    message: '输入您的题目'
  }
})
</script>
<script>

    function sendPost(){
        
        var1 = $("#content").html()
        $("#cnt2").val(var1);
        
        var2 = $("#title_input").val();
        console.log(var2)
        $("#cnt3").val(var2);
        console.log( $("#cnt3").val());
        $("#send_post_form").submit();
    
    };
    </script>

     <script type="text/javascript" src="../static/image-upload/webuploader.js"></script>
    <!-- <script type="text/javascript" src="../../static/image-upload/upload.js"></script> -->
    <script>
            (function( $ ){
            // 当domReady的时候开始初始化
            $(function() {
                var $wrap = $('#uploader'),
        
                    // 图片容器
                    $queue = $( '<ul class="filelist"></ul>' )
                        .appendTo( $wrap.find( '.queueList' ) ),
        
                    // 状态栏，包括进度和控制按钮
                    $statusBar = $wrap.find( '.statusBar' ),
        
                    // 文件总体选择信息。
                    $info = $statusBar.find( '.info' ),
        
                    // 上传按钮
                    $upload = $wrap.find( '.uploadBtn' ),
        
                    // 没选择文件之前的内容。
                    $placeHolder = $wrap.find( '.placeholder' ),
        
                    $progress = $statusBar.find( '.progress' ).hide(),
        
                    // 添加的文件数量
                    fileCount = 0,
        
                    // 添加的文件总大小
                    fileSize = 0,
        
                    // 优化retina, 在retina下这个值是2
                    ratio = window.devicePixelRatio || 1,
        
                    // 缩略图大小
                    thumbnailWidth = 110 * ratio,
                    thumbnailHeight = 110 * ratio,
        
                    // 可能有pedding, ready, uploading, confirm, done.
                    state = 'pedding',
        
                    // 所有文件的进度信息，key为file id
                    percentages = {},
                    // 判断浏览器是否支持图片的base64
                    isSupportBase64 = ( function() {
                        var data = new Image();
                        var support = true;
                        data.onload = data.onerror = function() {
                            if( this.width != 1 || this.height != 1 ) {
                                support = false;
                            }
                        }
                        data.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
                        return support;
                    } )(),
        
                    // 检测是否已经安装flash，检测flash的版本
                    flashVersion = ( function() {
                        var version;
        
                        try {
                            version = navigator.plugins[ 'Shockwave Flash' ];
                            version = version.description;
                        } catch ( ex ) {
                            try {
                                version = new ActiveXObject('ShockwaveFlash.ShockwaveFlash')
                                        .GetVariable('$version');
                            } catch ( ex2 ) {
                                version = '0.0';
                            }
                        }
                        version = version.match( /\d+/g );
                        return parseFloat( version[ 0 ] + '.' + version[ 1 ], 10 );
                    } )(),
        
                    supportTransition = (function(){
                        var s = document.createElement('p').style,
                            r = 'transition' in s ||
                                    'WebkitTransition' in s ||
                                    'MozTransition' in s ||
                                    'msTransition' in s ||
                                    'OTransition' in s;
                        s = null;
                        return r;
                    })(),
        
                    // WebUploader实例
                    uploader;
        
                if ( !WebUploader.Uploader.support('flash') && WebUploader.browser.ie ) {
        
                    // flash 安装了但是版本过低。
                    if (flashVersion) {
                        (function(container) {
                            window['expressinstallcallback'] = function( state ) {
                                switch(state) {
                                    case 'Download.Cancelled':
                                        alert('您取消了更新！')
                                        break;
        
                                    case 'Download.Failed':
                                        alert('安装失败')
                                        break;
        
                                    default:
                                        alert('安装已成功，请刷新！');
                                        break;
                                }
                                delete window['expressinstallcallback'];
                            };
        
                            var swf = './expressInstall.swf';
                            // insert flash object
                            var html = '<object type="application/' +
                                    'x-shockwave-flash" data="' +  swf + '" ';
        
                            if (WebUploader.browser.ie) {
                                html += 'classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" ';
                            }
        
                            html += 'width="100%" height="100%" style="outline:0">'  +
                                '<param name="movie" value="' + swf + '" />' +
                                '<param name="wmode" value="transparent" />' +
                                '<param name="allowscriptaccess" value="always" />' +
                            '</object>';
        
                            container.html(html);
        
                        })($wrap);
        
                    // 压根就没有安转。
                    } else {
                        $wrap.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>');
                    }
        
                    return;
                } else if (!WebUploader.Uploader.support()) {
                    alert( 'Web Uploader 不支持您的浏览器！');
                    return;
                }
        
                // 实例化
                uploader = WebUploader.create({
                    pick: {
                        id: '#filePicker',
                        label: '点击选择图片'
                    },
                    formData: {
                        uid: '23',
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        // csrfmiddlewaretoken: {% csrf_token %},
                        ///csrf: {% csrf_token %}
                    },
                    dnd: '#uploader .queueList',
                    paste: '#uploader',
                    swf: '/static/image-upload/Uploader.swf',
                    chunked: false,
                    chunkSize: 512 * 1024,
                    server: '/getimage/',
                    // csrf: {% csrf_token %},
                    // runtimeOrder: 'flash',
        
                    // accept: {
                    //     title: 'Images',
                    //     extensions: 'gif,jpg,jpeg,bmp,png',
                    //     mimeTypes: 'image/*'
                    // },
        
                    // 禁掉全局的拖拽功能。这样不会出现图片拖进页面的时候，把图片打开。
                    disableGlobalDnd: true,
                    fileNumLimit: 300,
                    fileSizeLimit: 200 * 1024 * 1024,    // 200 M
                    fileSingleSizeLimit: 50 * 1024 * 1024    // 50 M
                });
        
                // 拖拽时不接受 js, txt 文件。
                uploader.on( 'dndAccept', function( items ) {
                    var denied = false,
                        len = items.length,
                        i = 0,
                        // 修改js类型
                        unAllowed = 'text/plain;application/javascript ';
        
                    for ( ; i < len; i++ ) {
                        // 如果在列表里面
                        if ( ~unAllowed.indexOf( items[ i ].type ) ) {
                            denied = true;
                            break;
                        }
                    }
        
                    return !denied;
                });
        
                uploader.on('dialogOpen', function() {
                    console.log('here');
                });
        
                // uploader.on('filesQueued', function() {
                //     uploader.sort(function( a, b ) {
                //         if ( a.name < b.name )
                //           return -1;
                //         if ( a.name > b.name )
                //           return 1;
                //         return 0;
                //     });
                // });
        
                // 添加“添加文件”的按钮，
                uploader.addButton({
                    id: '#filePicker2',
                    label: '继续添加'
                });
        
                uploader.on('ready', function() {
                    window.uploader = uploader;
                });
        
                // 当有文件添加进来时执行，负责view的创建
                function addFile( file ) {
                    var $li = $( '<li id="' + file.id + '">' +
                            '<p class="title">' + file.name + '</p>' +
                            '<p class="imgWrap"></p>'+
                            '<p class="progress" style="display:none;"><span></span></p>' +
                            '</li>' ),
        
                        $btns = $('<div class="file-panel">' +
                            '<span class="cancel">删除</span>' +
                            '<span class="rotateRight">向右旋转</span>' +
                            '<span class="rotateLeft">向左旋转</span></div>').appendTo( $li ),
                        $prgress = $li.find('p.progress span'),
                        $wrap = $li.find( 'p.imgWrap' ),
                        $info = $('<p class="error"></p>'),
        
                        showError = function( code ) {
                            switch( code ) {
                                case 'exceed_size':
                                    text = '文件大小超出';
                                    break;
        
                                case 'interrupt':
                                    text = '上传暂停';
                                    break;
        
                                default:
                                    text = '上传失败，请重试';
                                    break;
                            }
        
                            $info.text( text ).appendTo( $li );
                        };
        
                    if ( file.getStatus() === 'invalid' ) {
                        showError( file.statusText );
                    } else {
                        // @todo lazyload
                        $wrap.text( '预览中' );
                        uploader.makeThumb( file, function( error, src ) {
                            var img;
        
                            if ( error ) {
                                $wrap.text( '不能预览' );
                                return;
                            }
        
                            if( isSupportBase64 ) {
                                img = $('<img src="'+src+'">');
                                $wrap.empty().append( img );
                            } else {
                                $.ajax('/thumb/', {
                                    method: 'POST',
                                    data: src,
                                    dataType:'json'
                                }).done(function( response ) {
                                    if (response.result) {
                                        img = $('<img src="'+response.result+'">');
                                        $wrap.empty().append( img );
                                    } else {
                                        $wrap.text("预览出错");
                                    }
                                });
                            }
                        }, thumbnailWidth, thumbnailHeight );
        
                        percentages[ file.id ] = [ file.size, 0 ];
                        file.rotation = 0;
                    }
        
                    file.on('statuschange', function( cur, prev ) {
                        if ( prev === 'progress' ) {
                            $prgress.hide().width(0);
                        } else if ( prev === 'queued' ) {
                            $li.off( 'mouseenter mouseleave' );
                            $btns.remove();
                        }
        
                        // 成功
                        if ( cur === 'error' || cur === 'invalid' ) {
                            console.log( file.statusText );
                            showError( file.statusText );
                            percentages[ file.id ][ 1 ] = 1;
                        } else if ( cur === 'interrupt' ) {
                            showError( 'interrupt' );
                        } else if ( cur === 'queued' ) {
                            $info.remove();
                            $prgress.css('display', 'block');
                            percentages[ file.id ][ 1 ] = 0;
                        } else if ( cur === 'progress' ) {
                            $info.remove();
                            $prgress.css('display', 'block');
                        } else if ( cur === 'complete' ) {
                            $prgress.hide().width(0);
                            $li.append( '<span class="success"></span>' );
                        }
        
                        $li.removeClass( 'state-' + prev ).addClass( 'state-' + cur );
                    });
        
                    $li.on( 'mouseenter', function() {
                        $btns.stop().animate({height: 30});
                    });
        
                    $li.on( 'mouseleave', function() {
                        $btns.stop().animate({height: 0});
                    });
        
                    $btns.on( 'click', 'span', function() {
                        var index = $(this).index(),
                            deg;
        
                        switch ( index ) {
                            case 0:
                                uploader.removeFile( file );
                                return;
        
                            case 1:
                                file.rotation += 90;
                                break;
        
                            case 2:
                                file.rotation -= 90;
                                break;
                        }
        
                        if ( supportTransition ) {
                            deg = 'rotate(' + file.rotation + 'deg)';
                            $wrap.css({
                                '-webkit-transform': deg,
                                '-mos-transform': deg,
                                '-o-transform': deg,
                                'transform': deg
                            });
                        } else {
                            $wrap.css( 'filter', 'progid:DXImageTransform.Microsoft.BasicImage(rotation='+ (~~((file.rotation/90)%4 + 4)%4) +')');
                            // use jquery animate to rotation
                            // $({
                            //     rotation: rotation
                            // }).animate({
                            //     rotation: file.rotation
                            // }, {
                            //     easing: 'linear',
                            //     step: function( now ) {
                            //         now = now * Math.PI / 180;
        
                            //         var cos = Math.cos( now ),
                            //             sin = Math.sin( now );
        
                            //         $wrap.css( 'filter', "progid:DXImageTransform.Microsoft.Matrix(M11=" + cos + ",M12=" + (-sin) + ",M21=" + sin + ",M22=" + cos + ",SizingMethod='auto expand')");
                            //     }
                            // });
                        }
        
        
                    });
        
                    $li.appendTo( $queue );
                }
        
                // 负责view的销毁
                function removeFile( file ) {
                    var $li = $('#'+file.id);
        
                    delete percentages[ file.id ];
                    updateTotalProgress();
                    $li.off().find('.file-panel').off().end().remove();
                }
        
                function updateTotalProgress() {
                    var loaded = 0,
                        total = 0,
                        spans = $progress.children(),
                        percent;
        
                    $.each( percentages, function( k, v ) {
                        total += v[ 0 ];
                        loaded += v[ 0 ] * v[ 1 ];
                    } );
        
                    percent = total ? loaded / total : 0;
        
        
                    spans.eq( 0 ).text( Math.round( percent * 100 ) + '%' );
                    spans.eq( 1 ).css( 'width', Math.round( percent * 100 ) + '%' );
                    updateStatus();
                }
        
                function updateStatus() {
                    var text = '', stats;
        
                    if ( state === 'ready' ) {
                        text = '选中' + fileCount + '张图片，共' +
                                WebUploader.formatSize( fileSize ) + '。';
                    } else if ( state === 'confirm' ) {
                        stats = uploader.getStats();
                        if ( stats.uploadFailNum ) {
                            text = '已成功上传' + stats.successNum+ '张照片至XX相册，'+
                                stats.uploadFailNum + '张照片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'
                        }
        
                    } else {
                        stats = uploader.getStats();
                        text = '共' + fileCount + '张（' +
                                WebUploader.formatSize( fileSize )  +
                                '），已上传' + stats.successNum + '张';
        
                        if ( stats.uploadFailNum ) {
                            text += '，失败' + stats.uploadFailNum + '张';
                        }
                    }
        
                   // $info.html( text );
                }
        
                function setState( val ) {
                    var file, stats;
        
                    if ( val === state ) {
                        return;
                    }
        
                    $upload.removeClass( 'state-' + state );
                    $upload.addClass( 'state-' + val );
                    state = val;
        
                    switch ( state ) {
                        case 'pedding':
                            $placeHolder.removeClass( 'element-invisible' );
                            $queue.hide();
                            $statusBar.addClass( 'element-invisible' );
                            uploader.refresh();
                            break;
        
                        case 'ready':
                            $placeHolder.addClass( 'element-invisible' );
                            $( '#filePicker2' ).removeClass( 'element-invisible');
                            $queue.show();
                            $statusBar.removeClass('element-invisible');
                            uploader.refresh();
                            break;
        
                        case 'uploading':
                            $( '#filePicker2' ).addClass( 'element-invisible' );
                            $progress.show();
                            $upload.text( '暂停上传' );
                            break;
        
                        case 'paused':
                            $progress.show();
                            $upload.text( '继续上传' );
                            break;
        
                        case 'confirm':
                            $progress.hide();
                            $( '#filePicker2' ).removeClass( 'element-invisible' );
                            $upload.text( '开始上传' );
        
                            stats = uploader.getStats();
                            if ( stats.successNum && !stats.uploadFailNum ) {
                                setState( 'finish' );
                                return;
                            }
                            break;
                        case 'finish':
                            stats = uploader.getStats();
                            if ( stats.successNum ) {
                                // alert( '上传成功' );
                                console.log()
                            } else {
                                // 没有成功的图片，重设
                                state = 'done';
                                location.reload();
                            }
                            break;
                    }
        
                    updateStatus();
                }
        
                uploader.onUploadProgress = function( file, percentage ) {
                    var $li = $('#'+file.id),
                        $percent = $li.find('.progress span');
        
                    $percent.css( 'width', percentage * 100 + '%' );
                    percentages[ file.id ][ 1 ] = percentage;
                    updateTotalProgress();
                };
        
                uploader.onFileQueued = function( file ) {
                    fileCount++;
                    fileSize += file.size;
        
                    if ( fileCount === 1 ) {
                        $placeHolder.addClass( 'element-invisible' );
                        $statusBar.show();
                    }
        
                    addFile( file );
                    setState( 'ready' );
                    updateTotalProgress();
                };
        
                uploader.onFileDequeued = function( file ) {
                    fileCount--;
                    fileSize -= file.size;
        
                    if ( !fileCount ) {
                        setState( 'pedding' );
                    }
        
                    removeFile( file );
                    updateTotalProgress();
        
                };
        
                uploader.on( 'all', function( type ) {
                    var stats;
                    switch( type ) {
                        case 'uploadFinished':
                            setState( 'confirm' );
                            break;
        
                        case 'startUpload':
                            setState( 'uploading' );
                            break;
        
                        case 'stopUpload':
                            setState( 'paused' );
                            break;
        
                    }
                });
        
                uploader.onError = function( code ) {
                    alert( 'Eroor: ' + code );
                };
        
                $upload.on('click', function() {
                    if ( $(this).hasClass( 'disabled' ) ) {
                        return false;
                    }
        
                    if ( state === 'ready' ) {
                        uploader.upload();
                    } else if ( state === 'paused' ) {
                        uploader.upload();
                    } else if ( state === 'uploading' ) {
                        uploader.stop();
                    }
                });
        
                $info.on( 'click', '.retry', function() {
                    uploader.retry();
                } );
        
                $info.on( 'click', '.ignore', function() {
                    alert( 'todo' );
                } );

                //上传成功
                uploader.on('uploadSuccess', function (file, response) {
                    var imagename = response._raw; //上传图片的路径
                    console.log(response)
                    var div_ = document.getElementById("content");  
                　　　　//添加 img
                　 var img = document.createElement("img");
                // 　 img.setAttribute("style", "width:50px;height:50px;");

                  img.setAttribute("class", "img-fluid");
                　　　　//设置 img 图片地址
                　　img.src = "/static/upload/img/"+imagename;
                
                    div_.appendChild(img);
                });
        
                $upload.addClass( 'state-' + state );
                updateTotalProgress();
            });

           
        
        })( jQuery );
        
         
    </script>
{% endblock  %}